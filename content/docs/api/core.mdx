---
title: "@keyloom/core API"
description: Complete API reference for the @keyloom/core package
---

import { Tabs, Tab } from 'fumadocs-ui/components/tabs'
import { Callout } from 'fumadocs-ui/components/callout'

# @keyloom/core API

The core authentication library providing all essential authentication functionality.

## Installation

<Tabs items={['npm', 'pnpm', 'yarn']}>
  <Tab value="npm">
    ```bash
    npm install @keyloom/core
    ```
  </Tab>
  <Tab value="pnpm">
    ```bash
    pnpm add @keyloom/core
    ```
  </Tab>
  <Tab value="yarn">
    ```bash
    yarn add @keyloom/core
    ```
  </Tab>
</Tabs>

## Runtime Functions

### `register(input, ctx)`

Register a new user with email and password.

**Parameters:**
- `input: RegisterInput` - User registration data
- `ctx: RegisterCtx` - Context with adapter and hasher

**Returns:** `Promise<{ user: User; requiresVerification: boolean }>`

```typescript
import { register, argon2idHasher, memoryAdapter } from "@keyloom/core";

const { user, requiresVerification } = await register(
  {
    email: "user@example.com",
    password: "secure-password",
    requireEmailVerify: true
  },
  {
    adapter: memoryAdapter(),
    hasher: argon2idHasher,
    audit: async (type, meta) => {
      console.log(`Audit: ${type}`, meta);
    }
  }
);
```

**Types:**
```typescript
interface RegisterInput {
  email: string;
  password: string;
  requireEmailVerify?: boolean;
}

interface RegisterCtx {
  adapter: Adapter & {
    createCredential(userId: ID, hash: string): Promise<{ id: ID; userId: ID }>;
  };
  hasher: {
    hash(pw: string): Promise<string>;
  };
  audit?: (type: string, meta?: { userId?: ID } & Record<string, unknown>) => Promise<void>;
}
```

### `login(input, ctx)`

Authenticate a user with email and password.

**Parameters:**
- `input: LoginInput` - Login credentials
- `ctx: LoginCtx` - Context with adapter and hasher

**Returns:** `Promise<{ user: User; session: Session }>`

```typescript
import { login, argon2idHasher, memoryAdapter } from "@keyloom/core";

const { user, session } = await login(
  {
    email: "user@example.com",
    password: "secure-password",
    ttlMinutes: 60
  },
  {
    adapter: memoryAdapter(),
    hasher: argon2idHasher
  }
);
```

**Types:**
```typescript
interface LoginInput {
  email: string;
  password: string;
  ttlMinutes?: number;
}

interface LoginCtx {
  adapter: Adapter & {
    getCredentialByUserId(userId: ID): Promise<{ hash: string } | null>;
  };
  hasher: {
    verify(hash: string, pw: string): Promise<boolean>;
  };
}
```

### `logout(sessionId, adapter)`

End a user session.

**Parameters:**
- `sessionId: string` - Session ID to terminate
- `adapter: Adapter` - Database adapter

**Returns:** `Promise<void>`

```typescript
import { logout, memoryAdapter } from "@keyloom/core";

await logout("session-id", memoryAdapter());
```

### `getCurrentSession(sessionId, adapter)`

Retrieve current session data.

**Parameters:**
- `sessionId: string` - Session ID to retrieve
- `adapter: Adapter` - Database adapter

**Returns:** `Promise<{ session: Session; user: User } | null>`

```typescript
import { getCurrentSession, memoryAdapter } from "@keyloom/core";

const result = await getCurrentSession("session-id", memoryAdapter());
if (result) {
  const { session, user } = result;
  console.log(`User ${user.email} session expires at ${session.expiresAt}`);
}
```

## Session Management

### `newSession(userId, ttlMinutes?)`

Create a new session object.

**Parameters:**
- `userId: string` - User ID for the session
- `ttlMinutes?: number` - Session TTL in minutes (default: 60)

**Returns:** `Omit<Session, 'id' | 'createdAt' | 'updatedAt'>`

```typescript
import { newSession } from "@keyloom/core";

const sessionData = newSession("user-id", 120);
const session = await adapter.createSession(sessionData);
```

### `serializeSessionCookie(sessionId, options?)`

Serialize a session ID into a cookie string.

**Parameters:**
- `sessionId: string` - Session ID to serialize
- `options?: CookieOptions` - Cookie configuration

**Returns:** `string`

```typescript
import { serializeSessionCookie } from "@keyloom/core";

const cookie = serializeSessionCookie("session-id", {
  domain: "example.com",
  secure: true,
  sameSite: "lax",
  httpOnly: true,
  path: "/"
});

// Set cookie in response
response.setHeader("Set-Cookie", cookie);
```

## CSRF Protection

### `csrf.issueCsrfToken()`

Generate a new CSRF token.

**Returns:** `string`

```typescript
import { csrf } from "@keyloom/core";

const token = csrf.issueCsrfToken();
// Use token in forms and validate on submission
```

### `csrf.validateDoubleSubmit(tokens)`

Validate CSRF token using double-submit pattern.

**Parameters:**
- `tokens: { cookieToken?: string | null; headerToken?: string | null }`

**Returns:** `boolean`

```typescript
import { csrf } from "@keyloom/core";

const isValid = csrf.validateDoubleSubmit({
  cookieToken: request.cookies.get("csrf-token"),
  headerToken: request.headers.get("x-csrf-token")
});

if (!isValid) {
  throw new Error("CSRF validation failed");
}
```

## OAuth Flow

### `startOAuth(provider, options)`

Initiate OAuth authentication flow.

**Parameters:**
- `provider: OAuthProvider` - OAuth provider configuration
- `options: { redirectUri: string; scopes?: string[] }`

**Returns:** `Promise<{ url: string; state: string }>`

```typescript
import { startOAuth } from "@keyloom/core";
import github from "@keyloom/providers/github";

const provider = github({
  clientId: process.env.GITHUB_CLIENT_ID!,
  clientSecret: process.env.GITHUB_CLIENT_SECRET!
});

const { url, state } = await startOAuth(provider, {
  redirectUri: "http://localhost:3000/auth/callback",
  scopes: ["user:email"]
});

// Redirect user to OAuth provider
response.redirect(url);
```

### `completeOAuth(provider, params, ctx)`

Complete OAuth authentication flow.

**Parameters:**
- `provider: OAuthProvider` - OAuth provider configuration
- `params: { code: string; state: string }` - OAuth callback parameters
- `ctx: { adapter: Adapter }` - Context with adapter

**Returns:** `Promise<{ user: User; account: Account }>`

```typescript
import { completeOAuth } from "@keyloom/core";

const { user, account } = await completeOAuth(
  provider,
  {
    code: request.query.code,
    state: request.query.state
  },
  { adapter: memoryAdapter() }
);
```

## Password Hashing

### `argon2idHasher`

Secure password hasher using Argon2id algorithm.

```typescript
import { argon2idHasher } from "@keyloom/core";

// Hash password
const hash = await argon2idHasher.hash("user-password");

// Verify password
const isValid = await argon2idHasher.verify(hash, "user-password");
```

### `bcryptHasher`

Alternative password hasher using bcrypt algorithm.

```typescript
import { bcryptHasher } from "@keyloom/core";

const hash = await bcryptHasher.hash("user-password");
const isValid = await bcryptHasher.verify(hash, "user-password");
```

### `devHasher`

Development-only hasher (not secure, for testing only).

<Callout type="warn">
  Never use `devHasher` in production. It provides no security.
</Callout>

```typescript
import { devHasher } from "@keyloom/core";

// Only for development/testing
const hash = await devHasher.hash("password");
const isValid = await devHasher.verify(hash, "password");
```

## Memory Adapter

### `memoryAdapter(options?)`

In-memory adapter for development and testing.

**Parameters:**
- `options?: { store?: MemoryStore }` - Optional pre-initialized store

**Returns:** `Adapter & MemoryAdapterExtensions`

```typescript
import { memoryAdapter } from "@keyloom/core";

const adapter = memoryAdapter();

// Create user
const user = await adapter.createUser({
  email: "user@example.com",
  name: "John Doe"
});

// Create session
const session = await adapter.createSession({
  userId: user.id,
  expiresAt: new Date(Date.now() + 60 * 60 * 1000) // 1 hour
});
```

<Callout type="warn">
  The memory adapter stores data in memory and will lose all data when the process restarts. Use only for development and testing.
</Callout>

## Utilities

### `newId()`

Generate a unique identifier.

**Returns:** `string`

```typescript
import { newId } from "@keyloom/core";

const id = newId(); // Generates a unique ID
```

### `util.now()`

Get current timestamp as Date object.

**Returns:** `Date`

```typescript
import { util } from "@keyloom/core";

const now = util.now();
```

### `util.addMinutes(date, minutes)`

Add minutes to a date.

**Parameters:**
- `date: Date` - Base date
- `minutes: number` - Minutes to add

**Returns:** `Date`

```typescript
import { util } from "@keyloom/core";

const future = util.addMinutes(new Date(), 60); // 1 hour from now
```

## Error Handling

### `KeyloomError`

Custom error class for Keyloom-specific errors.

```typescript
import { KeyloomError, ERR } from "@keyloom/core";

try {
  await login(credentials, ctx);
} catch (error) {
  if (error instanceof KeyloomError) {
    console.log(`Error code: ${error.code}`);
    console.log(`Error message: ${error.message}`);
  }
}
```

### Error Codes

```typescript
import { ERR } from "@keyloom/core";

// Common error codes
ERR.USER_NOT_FOUND        // User does not exist
ERR.EMAIL_EXISTS          // Email already registered
ERR.INVALID_CREDENTIALS   // Invalid login credentials
ERR.SESSION_EXPIRED       // Session has expired
ERR.CSRF_MISMATCH        // CSRF token validation failed
```

## Constants

```typescript
import { 
  COOKIE_NAME,
  DEFAULT_SESSION_TTL_MINUTES,
  JWT_AUDIENCE,
  JWT_ISSUER 
} from "@keyloom/core";

console.log(COOKIE_NAME);                    // "__keyloom_session"
console.log(DEFAULT_SESSION_TTL_MINUTES);    // 60
console.log(JWT_AUDIENCE);                   // "keyloom"
console.log(JWT_ISSUER);                     // "keyloom"
```
