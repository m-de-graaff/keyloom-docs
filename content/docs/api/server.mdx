---
title: "@keyloom/server API"
description: Complete API reference for the standalone server implementation
---

import { Tabs, Tab } from 'fumadocs-ui/components/tabs'
import { Callout } from 'fumadocs-ui/components/callout'
import { Steps, Step } from 'fumadocs-ui/components/steps'

# @keyloom/server API

Standalone server implementation for Keyloom providing authentication APIs using Fastify.

<Callout type="info">
  The server package is currently in development and may have limited functionality compared to the Next.js integration.
</Callout>

## Installation

<Tabs items={['npm', 'pnpm', 'yarn']}>
  <Tab value="npm">
    ```bash
    npm install @keyloom/server @keyloom/core @keyloom/adapters
    ```
  </Tab>
  <Tab value="pnpm">
    ```bash
    pnpm add @keyloom/server @keyloom/core @keyloom/adapters
    ```
  </Tab>
  <Tab value="yarn">
    ```bash
    yarn add @keyloom/server @keyloom/core @keyloom/adapters
    ```
  </Tab>
</Tabs>

## Quick Start

### Environment Configuration

Create a `.env` file with required environment variables:

```bash
# Server Configuration
PORT=8787
DATABASE_URL=postgresql://username:password@localhost:5432/keyloom

# Authentication
AUTH_SECRET=your-super-secret-key-here

# Cookie Configuration (optional)
COOKIE_DOMAIN=localhost
COOKIE_SAMESITE=lax
```

### Basic Server Setup

```typescript
// server.ts
import { buildServer } from "@keyloom/server";

const env = {
  PORT: process.env.PORT || "8787",
  DATABASE_URL: process.env.DATABASE_URL!,
  AUTH_SECRET: process.env.AUTH_SECRET!,
  COOKIE_DOMAIN: process.env.COOKIE_DOMAIN,
  COOKIE_SAMESITE: (process.env.COOKIE_SAMESITE as "lax" | "strict" | "none") || "lax",
};

const app = buildServer(env);

app.listen({ port: Number(env.PORT), host: "0.0.0.0" }).then(() => {
  console.log(`Keyloom server running on port ${env.PORT}`);
});
```

### Run the Server

```bash
# Development
npm run dev

# Production
npm start
```

## API Endpoints

The server provides the following REST API endpoints:

### Authentication Endpoints

#### `GET /v1/auth/csrf`

Get a CSRF token for secure form submissions.

**Response:**
```json
{
  "csrfToken": "random-csrf-token-string"
}
```

**Headers:**
- Sets `__keyloom_csrf` cookie with the token

**Example:**
```bash
curl http://localhost:8787/v1/auth/csrf
```

#### `POST /v1/auth/register`

Register a new user account.

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "secure-password"
}
```

**Headers:**
- `Content-Type: application/json`
- `X-Keyloom-CSRF: csrf-token-from-cookie`
- `Cookie: __keyloom_csrf=csrf-token`

**Response:**
```json
{
  "userId": "user-id-string",
  "requiresVerification": false
}
```

**Rate Limiting:** 5 requests per IP, refills at 0.2/second

**Example:**
```bash
# Get CSRF token first
CSRF_TOKEN=$(curl -s http://localhost:8787/v1/auth/csrf | jq -r '.csrfToken')

# Register user
curl -X POST http://localhost:8787/v1/auth/register \
  -H "Content-Type: application/json" \
  -H "X-Keyloom-CSRF: $CSRF_TOKEN" \
  -H "Cookie: __keyloom_csrf=$CSRF_TOKEN" \
  -d '{"email":"user@example.com","password":"password123"}'
```

#### `POST /v1/auth/login`

Authenticate a user and create a session.

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "secure-password"
}
```

**Headers:**
- `Content-Type: application/json`
- `X-Keyloom-CSRF: csrf-token-from-cookie`
- `Cookie: __keyloom_csrf=csrf-token`

**Response:**
```json
{
  "sessionId": "session-id-string"
}
```

**Headers:**
- Sets `__keyloom_session` cookie with session ID

**Rate Limiting:** 10 requests per IP, refills at 1/second

**Example:**
```bash
curl -X POST http://localhost:8787/v1/auth/login \
  -H "Content-Type: application/json" \
  -H "X-Keyloom-CSRF: $CSRF_TOKEN" \
  -H "Cookie: __keyloom_csrf=$CSRF_TOKEN" \
  -d '{"email":"user@example.com","password":"password123"}'
```

#### `POST /v1/auth/logout`

End the current user session.

**Headers:**
- `Cookie: __keyloom_session=session-id`

**Response:**
```json
{
  "ok": true
}
```

**Headers:**
- Clears `__keyloom_session` cookie

**Example:**
```bash
curl -X POST http://localhost:8787/v1/auth/logout \
  -H "Cookie: __keyloom_session=session-id"
```

#### `GET /v1/auth/session`

Get current session and user information.

**Headers:**
- `Cookie: __keyloom_session=session-id`

**Response:**
```json
{
  "session": {
    "id": "session-id",
    "userId": "user-id",
    "expiresAt": "2024-01-01T12:00:00.000Z",
    "createdAt": "2024-01-01T10:00:00.000Z",
    "updatedAt": "2024-01-01T10:00:00.000Z"
  },
  "user": {
    "id": "user-id",
    "email": "user@example.com"
  }
}
```

**Example:**
```bash
curl http://localhost:8787/v1/auth/session \
  -H "Cookie: __keyloom_session=session-id"
```

## Server Configuration

### Environment Variables

```typescript
interface ServerEnv {
  PORT: string;                    // Server port (default: "8787")
  DATABASE_URL: string;            // Database connection string
  AUTH_SECRET: string;             // Secret for signing tokens (min 16 chars)
  COOKIE_DOMAIN?: string;          // Cookie domain (optional)
  COOKIE_SAMESITE: "lax" | "strict" | "none"; // Cookie SameSite policy
}
```

### Configuration Validation

The server uses Zod for environment validation:

```typescript
import { z } from "zod";

const Env = z.object({
  PORT: z.string().default("8787"),
  DATABASE_URL: z.string(),
  AUTH_SECRET: z.string().min(16),
  COOKIE_DOMAIN: z.string().optional(),
  COOKIE_SAMESITE: z.enum(["lax", "strict", "none"]).default("lax"),
});
```

## Custom Server Implementation

You can create a custom server using the core components:

```typescript
import Fastify from "fastify";
import { PrismaAdapter } from "@keyloom/adapters/prisma";
import { PrismaClient } from "@prisma/client";
import * as core from "@keyloom/core";

function createCustomServer() {
  const app = Fastify({ trustProxy: true });
  const db = new PrismaClient();
  const adapter = PrismaAdapter(db);
  const hasher = core.argon2idHasher;

  // Custom authentication endpoint
  app.post("/auth/custom-login", async (request, reply) => {
    const { email, password } = request.body as any;
    
    try {
      const { user, session } = await core.login(
        { email, password },
        { adapter, hasher }
      );
      
      // Set session cookie
      reply.setCookie("session", session.id, {
        httpOnly: true,
        secure: process.env.NODE_ENV === "production",
        sameSite: "lax",
        maxAge: 60 * 60 * 24 * 7, // 7 days
      });
      
      return { user: { id: user.id, email: user.email } };
    } catch (error) {
      reply.code(401);
      return { error: "Invalid credentials" };
    }
  });

  // Protected route example
  app.get("/protected", async (request, reply) => {
    const sessionId = request.cookies.session;
    
    if (!sessionId) {
      reply.code(401);
      return { error: "No session" };
    }
    
    const { user } = await core.getCurrentSession(sessionId, adapter);
    
    if (!user) {
      reply.code(401);
      return { error: "Invalid session" };
    }
    
    return { message: `Hello ${user.email}!` };
  });

  return app;
}

const server = createCustomServer();
server.listen({ port: 3000 });
```

## Security Features

### CSRF Protection

All POST endpoints require CSRF token validation:

```typescript
const isValid = core.csrf.validateDoubleSubmit({
  cookieToken: request.cookies.__keyloom_csrf,
  headerToken: request.headers["x-keyloom-csrf"],
});

if (!isValid) {
  return reply.code(403).send({ error: "csrf" });
}
```

### Rate Limiting

Built-in rate limiting for authentication endpoints:

```typescript
// Registration: 5 requests per IP, refills at 0.2/second
const registrationLimit = core.rateLimit.rateLimit(`reg:${ip}`, {
  capacity: 5,
  refillPerSec: 0.2,
});

// Login: 10 requests per IP, refills at 1/second
const loginLimit = core.rateLimit.rateLimit(`login:${ip}`, {
  capacity: 10,
  refillPerSec: 1,
});
```

### Secure Cookies

Session cookies are configured with security best practices:

```typescript
const cookieOptions = {
  httpOnly: true,
  secure: process.env.NODE_ENV === "production",
  sameSite: env.COOKIE_SAMESITE,
  domain: env.COOKIE_DOMAIN,
  path: "/",
};
```

## Database Integration

The server uses Prisma adapter by default:

```typescript
import { PrismaAdapter } from "@keyloom/adapters/prisma";
import { PrismaClient } from "@prisma/client";

const db = new PrismaClient();
const adapter = PrismaAdapter(db);
```

Ensure your database has the required Keyloom schema. See the [Adapters documentation](/api/adapters) for schema details.

## Error Handling

The server returns consistent error responses:

```typescript
// Rate limiting
{ "error": "rate_limited" }

// CSRF validation failed
{ "error": "csrf" }

// Authentication failed
{ "error": "invalid_credentials" }

// User not found
{ "error": "user_not_found" }

// Validation errors
{ "error": "validation_failed", "details": [...] }
```

## Deployment

### Docker Deployment

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 8787

CMD ["npm", "start"]
```

### Environment Variables for Production

```bash
# Production environment
NODE_ENV=production
PORT=8787
DATABASE_URL=postgresql://user:pass@db:5432/keyloom
AUTH_SECRET=your-production-secret-key
COOKIE_DOMAIN=yourdomain.com
COOKIE_SAMESITE=lax
```

### Health Check Endpoint

Add a health check endpoint:

```typescript
app.get("/health", async () => {
  return { status: "ok", timestamp: new Date().toISOString() };
});
```

## Integration Examples

### Frontend Integration

```typescript
// Frontend authentication service
class AuthService {
  private baseUrl = "http://localhost:8787";

  async getCsrfToken() {
    const response = await fetch(`${this.baseUrl}/v1/auth/csrf`);
    const data = await response.json();
    return data.csrfToken;
  }

  async login(email: string, password: string) {
    const csrfToken = await this.getCsrfToken();
    
    const response = await fetch(`${this.baseUrl}/v1/auth/login`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Keyloom-CSRF": csrfToken,
      },
      credentials: "include",
      body: JSON.stringify({ email, password }),
    });
    
    return response.json();
  }

  async getSession() {
    const response = await fetch(`${this.baseUrl}/v1/auth/session`, {
      credentials: "include",
    });
    
    return response.json();
  }

  async logout() {
    const response = await fetch(`${this.baseUrl}/v1/auth/logout`, {
      method: "POST",
      credentials: "include",
    });
    
    return response.json();
  }
}
```

### API Gateway Integration

```typescript
// Use with API Gateway or reverse proxy
app.register(async function (fastify) {
  fastify.addHook("preHandler", async (request, reply) => {
    // Add CORS headers
    reply.header("Access-Control-Allow-Origin", "https://yourdomain.com");
    reply.header("Access-Control-Allow-Credentials", "true");
    reply.header("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
    reply.header("Access-Control-Allow-Headers", "Content-Type,X-Keyloom-CSRF");
  });
});
```

## Monitoring and Logging

### Request Logging

```typescript
app.register(require("@fastify/formbody"));
app.register(require("@fastify/cookie"));

app.addHook("onRequest", async (request, reply) => {
  console.log(`${request.method} ${request.url} - ${request.ip}`);
});

app.addHook("onResponse", async (request, reply) => {
  console.log(`${request.method} ${request.url} - ${reply.statusCode}`);
});
```

### Metrics Collection

```typescript
let requestCount = 0;
let authAttempts = 0;

app.addHook("onRequest", async () => {
  requestCount++;
});

app.get("/metrics", async () => {
  return {
    requests: requestCount,
    authAttempts,
    uptime: process.uptime(),
  };
});
```

## Limitations

<Callout type="warn">
  The server package is currently in early development and has some limitations:
  
  - No OAuth provider support yet
  - Limited RBAC functionality
  - No email verification endpoints
  - Basic error handling
  - No built-in admin interface
</Callout>

## Next Steps

- [Core API Documentation](/api/core) - Understand the underlying authentication logic
- [Adapters Documentation](/api/adapters) - Set up database integration
- [Next.js Integration](/api/nextjs) - For full-featured web applications
