---
title: Runtime Flows
description: Register, login, logout, and current session helpers in @keyloom/core.
---

# Runtime Flows

The core exposes minimal runtime flows for credential auth with database sessions. These compose with your adapter and hashing implementation.

> For OAuth, see the Next.js handler section; for JWT sessions, see the Next.js JWT docs or the `@keyloom/server` package.

## register(input, ctx)

```ts
import { register } from "@keyloom/core/runtime/register";

export type RegisterInput = {
  email: string;
  password: string;
  requireEmailVerify?: boolean;
}
export type RegisterCtx = {
  adapter: Adapter & { createCredential(userId: ID, hash: string): Promise<{ id: ID; userId: ID }> }
  hasher: { hash(pw: string): Promise<string> }
  audit?: (type: string, meta?: { userId?: ID } & Record<string, unknown>) => Promise<void>
}
```

- Purpose: create a user, store credentials, optionally require email verification
- Returns: `{ user, requiresVerification }`
- Errors: Throws `KeyloomError(ERR.EMAIL_EXISTS)` if duplicate email

Example:

```ts
const out = await register({ email, password, requireEmailVerify: false }, {
  adapter,
  hasher: argon2idHasher,
});
```

## login(input, ctx)

```ts
import { login } from "@keyloom/core/runtime/login";

export type LoginInput = { email: string; password: string; ttlMinutes?: number };
export type LoginCtx = {
  adapter: Adapter & { getCredentialByUserId(userId: ID): Promise<{ hash: string } | null> }
  hasher: { verify(hash: string, pw: string): Promise<boolean> }
}
```

- Purpose: verify credentials and create a session (database strategy)
- Returns: `{ user, session }`
- Errors: `ERR.USER_NOT_FOUND`, `CREDENTIAL_NOT_FOUND`, `INVALID_CREDENTIALS`

Example:

```ts
const { session } = await login({ email, password, ttlMinutes: 60 }, { adapter, hasher });
```

## logout(sessionId, adapter)

```ts
import { logout } from "@keyloom/core/runtime/logout";
await logout(session.id, adapter);
```

- Purpose: delete a session id
- Returns: void

## getCurrentSession(cookieValue, adapter)

```ts
import { getCurrentSession } from "@keyloom/core/runtime/current-session";
const { session, user } = await getCurrentSession(sessionIdFromCookie, adapter);
```

- Purpose: look up session + user by cookie value
- Returns: `{ session: Session | null, user: User | null }`

## CSRF & Verification Tokens

- `csrf.issueCsrfToken()` and `csrf.validateDoubleSubmit({ cookieToken, headerToken })`
- `tokens.issueVerificationToken(identifier, ttlMinutes?)`  generate email/password-reset tokens (store hashed via adapter implementations)

## Troubleshooting

- Invalid login: ensure credentials were created on register; hash/verify functions must match
- Session not found: confirm cookie is set and adapter persists sessions
- CSRF 403: ensure you send `x-keyloom-csrf` header matching the `__keyloom_csrf` cookie

