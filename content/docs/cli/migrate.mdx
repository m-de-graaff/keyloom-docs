---
title: keyloom migrate
description: Manage database migrations for Keyloom authentication tables with rollback support and migration history tracking.
---

import {
  Tabs,
  TabsList,
  TabsTrigger,
  TabsContent,
} from "fumadocs-ui/components/tabs";

# keyloom migrate

Manage database migrations for Keyloom authentication tables with rollback support, migration history tracking, and cross-adapter compatibility.

## Overview

The `keyloom migrate` command provides a unified interface for managing database migrations across different adapters. It handles schema changes, data migrations, and maintains migration history for reliable database evolution.

## Usage

<Tabs defaultValue="npm">
  <TabsList>
    <TabsTrigger value="npm">
    <NpmIcon />
    npm
    </TabsTrigger>
    <TabsTrigger value="pnpm">
    <PnpmIcon />
    pnpm
    </TabsTrigger>
    <TabsTrigger value="yarn">
    <YarnIcon />
    yarn
    </TabsTrigger>
    <TabsTrigger value="bun">
    <BunIcon />
    bun
    </TabsTrigger>
  </TabsList>

  <TabsContent value="npm">

```bash title="npm"
# Run pending migrations
npx keyloom migrate up

# Rollback last migration
npx keyloom migrate down

# Check migration status
npx keyloom migrate status

# Create new migration
npx keyloom migrate create <name>
```

  </TabsContent>
  <TabsContent value="pnpm">

```bash title="pnpm"
# Run pending migrations
pnpm dlx keyloom migrate up

# Rollback last migration
pnpm dlx keyloom migrate down

# Check migration status
pnpm dlx keyloom migrate status

# Create new migration
pnpm dlx keyloom migrate create <name>
```

  </TabsContent>
  <TabsContent value="yarn">

```bash title="yarn"
# Run pending migrations
yarn dlx keyloom migrate up

# Rollback last migration
yarn dlx keyloom migrate down

# Check migration status
yarn dlx keyloom migrate status

# Create new migration
yarn dlx keyloom migrate create <name>
```

  </TabsContent>
  <TabsContent value="bun">

```bash title="bun"
# Run pending migrations
bunx keyloom migrate up

# Rollback last migration
bunx keyloom migrate down

# Check migration status
bunx keyloom migrate status

# Create new migration
bunx keyloom migrate create <name>
```

  </TabsContent>

</Tabs>

## Commands

### `migrate up`

Apply all pending migrations to the database.

```bash
npx keyloom migrate up

# Apply specific number of migrations
npx keyloom migrate up --steps 2

# Dry run (show what would be executed)
npx keyloom migrate up --dry-run
```

**Flags:**
- `--steps <number>` - Apply only specified number of migrations
- `--dry-run` - Show migration SQL without executing
- `--force` - Skip confirmation prompts
- `--verbose` - Show detailed execution logs

### `migrate down`

Rollback migrations from the database.

```bash
npx keyloom migrate down

# Rollback specific number of migrations
npx keyloom migrate down --steps 2

# Rollback to specific migration
npx keyloom migrate down --to 20240101000000
```

**Flags:**
- `--steps <number>` - Rollback specified number of migrations
- `--to <migration>` - Rollback to specific migration ID
- `--dry-run` - Show rollback SQL without executing
- `--force` - Skip confirmation prompts

### `migrate status`

Show current migration status and history.

```bash
npx keyloom migrate status

# Show detailed migration info
npx keyloom migrate status --verbose
```

**Sample Output:**
```text
Migration Status

Database: postgresql://localhost:5432/myapp
Adapter: Prisma

Applied Migrations:
âœ“ 20240101000000_initial_schema
âœ“ 20240102000000_add_rbac
âœ“ 20240103000000_add_refresh_tokens

Pending Migrations:
â—‹ 20240104000000_add_audit_log
â—‹ 20240105000000_add_mfa_support

Status: 2 pending migrations
```

### `migrate create`

Create a new migration file.

```bash
npx keyloom migrate create add_user_preferences

# Create with specific adapter
npx keyloom migrate create add_user_preferences --adapter prisma
```

**Generated Files:**
```text
migrations/
â””â”€â”€ 20240106120000_add_user_preferences/
    â”œâ”€â”€ migration.sql
    â””â”€â”€ rollback.sql
```

## Migration File Structure

### Prisma Migrations

```text
prisma/migrations/
â””â”€â”€ 20240101000000_initial_schema/
    â””â”€â”€ migration.sql
```

```sql title="migration.sql"
-- CreateTable
CREATE TABLE "users" (
    "id" TEXT NOT NULL,
    "email" TEXT,
    "name" TEXT,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "users_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "users_email_key" ON "users"("email");
```

### Drizzle Migrations

```text
drizzle/migrations/
â”œâ”€â”€ 0001_initial_schema.sql
â””â”€â”€ meta/
    â””â”€â”€ _journal.json
```

```sql title="0001_initial_schema.sql"
CREATE TABLE IF NOT EXISTS "users" (
	"id" varchar(191) PRIMARY KEY NOT NULL,
	"email" varchar(191),
	"name" varchar(191),
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp DEFAULT now() NOT NULL
);

CREATE UNIQUE INDEX IF NOT EXISTS "users_email_idx" ON "users" ("email");
```

### Raw SQL Migrations

```text
migrations/
â”œâ”€â”€ 001_initial_schema.up.sql
â”œâ”€â”€ 001_initial_schema.down.sql
â”œâ”€â”€ 002_add_rbac.up.sql
â””â”€â”€ 002_add_rbac.down.sql
```

```sql title="001_initial_schema.up.sql"
-- Up migration
CREATE TABLE users (
  id VARCHAR(191) PRIMARY KEY,
  email VARCHAR(191) UNIQUE,
  name VARCHAR(191),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

```sql title="001_initial_schema.down.sql"
-- Down migration
DROP TABLE IF EXISTS users;
```

## Migration Execution Process

### 1. Pre-migration Checks

```text
ðŸ” Pre-migration checks...
âœ“ Database connection successful
âœ“ Migration table exists
âœ“ No conflicting migrations
âœ“ Backup recommended for production
```

### 2. Migration Execution

```text
ðŸ“ Applying migrations...

â†’ 20240104000000_add_audit_log
  âœ“ CREATE TABLE audit_events
  âœ“ CREATE INDEX idx_audit_events_user_id
  âœ“ Migration completed in 0.12s

â†’ 20240105000000_add_mfa_support  
  âœ“ ALTER TABLE users ADD COLUMN mfa_enabled
  âœ“ CREATE TABLE mfa_secrets
  âœ“ Migration completed in 0.08s

âœ… Applied 2 migrations successfully
```

### 3. Post-migration Validation

```text
ðŸ” Post-migration validation...
âœ“ All tables created successfully
âœ“ Indexes applied correctly
âœ“ Foreign key constraints valid
âœ“ Migration history updated
```

## Rollback Process

### Safe Rollback

```bash
npx keyloom migrate down --steps 1
```

```text
âš ï¸  Rolling back migration: 20240105000000_add_mfa_support

This will:
- DROP TABLE mfa_secrets
- DROP COLUMN users.mfa_enabled

? Continue with rollback? (y/N) â€º y

ðŸ“ Rolling back...
âœ“ Rollback completed successfully
```

### Rollback with Data Loss Warning

```text
âš ï¸  WARNING: This rollback may cause data loss!

The following data will be permanently deleted:
- Table: mfa_secrets (contains 150 records)
- Column: users.mfa_enabled (contains data for 45 users)

? Type 'CONFIRM' to proceed: â€º CONFIRM
```

## Adapter-Specific Features

### Prisma Integration

```bash
# Use Prisma's migration system
npx keyloom migrate up
# Equivalent to: npx prisma db push
```

### Drizzle Integration

```bash
# Use Drizzle Kit for migrations
npx keyloom migrate up
# Equivalent to: npx drizzle-kit push
```

### Raw SQL Support

```bash
# Execute raw SQL migrations
npx keyloom migrate up --adapter postgres
```

## Production Considerations

### Backup Before Migration

```bash
# Automatic backup prompt
npx keyloom migrate up
```

```text
âš ï¸  Production database detected!

Recommended: Create backup before migration
? Create backup now? (Y/n) â€º Y

ðŸ“¦ Creating backup...
âœ“ Backup saved: backup_20240106_120000.sql
```

### Zero-Downtime Migrations

```bash
# Check for breaking changes
npx keyloom migrate up --check-breaking

# Apply non-breaking migrations first
npx keyloom migrate up --safe-only
```

### Migration Locking

```text
ðŸ”’ Acquiring migration lock...
âœ“ Lock acquired (expires in 30 minutes)

ðŸ“ Applying migrations...
âœ“ Migrations completed
âœ“ Lock released
```

## Troubleshooting

**Migration failed mid-execution**
```text
Error: Migration failed at step 3/5
```
- Check database logs for specific error
- Verify database permissions
- Use `--dry-run` to test migration SQL
- Consider manual intervention for partial state

**Migration lock timeout**
```text
Error: Could not acquire migration lock
```
- Another migration process may be running
- Check for stale locks: `keyloom migrate unlock`
- Wait for current migration to complete

**Rollback not possible**
```text
Error: Cannot rollback - no down migration found
```
- Not all migrations support rollback
- Create manual rollback script
- Restore from backup if necessary

**Schema drift detected**
```text
Warning: Database schema differs from migration history
```
- Run `keyloom migrate status` to check state
- Use `keyloom migrate reset` to rebuild from scratch
- Manually align schema with migration files

## Advanced Usage

### Custom Migration Directory

```bash
npx keyloom migrate up --migrations-dir ./custom/migrations
```

### Multiple Environments

```bash
# Development
npx keyloom migrate up --env development

# Staging
npx keyloom migrate up --env staging

# Production
npx keyloom migrate up --env production --require-backup
```

### Migration Hooks

```ts title="keyloom.config.ts"
export default defineKeyloom({
  migrations: {
    hooks: {
      beforeMigration: async (migration) => {
        console.log(`Starting migration: ${migration.name}`);
      },
      afterMigration: async (migration) => {
        console.log(`Completed migration: ${migration.name}`);
      },
    },
  },
});
```

## See also

- [CLI Overview](/docs/cli/overview)
- [Generate Command](/docs/cli/generate)
- [Adapters Overview](/docs/adapters/overview)
- [Database Configuration](/docs/core/config)
