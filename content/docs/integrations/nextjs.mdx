---
title: Next.js Integration
---

import { Step, Steps } from "fumadocs-ui/components/steps";
import { Tabs, Tab } from "fumadocs-ui/components/tabs";
import { Callout } from "fumadocs-ui/components/callout";

Keyloom provides first-class Next.js support with a shared API handler, middleware, and helpers for both the App Router and the Pages Router.

## Features

- App Router and Pages Router support
- Middleware-based route protection
- Server helpers like `guard` and `getSession`
- Works in Server Components and Client Components

## Setup

<Steps>

### 1) Environment variables

```bash
NEXT_PUBLIC_APP_URL=https://your-app.example.com
AUTH_SECRET=base64url-32-bytes-min
DATABASE_URL=postgres://...
```

<Callout>
  AUTH_SECRET must be base64url (A–Z a–z 0–9 - _) and decode to at least 32
  bytes. `keyloom doctor --fix` can generate it.
</Callout>

### 2) Configure the API route

<Tabs>
<Tab value="app-router" title="App Router">

```ts
// app/api/auth/[[...keyloom]]/route.ts
import { createNextHandler } from "@keyloom/nextjs";
import config from "@/keyloom.config";
export const { GET, POST } = createNextHandler(config);
```

</Tab>
<Tab value="pages-router" title="Pages Router">

```ts
// pages/api/auth/[...keyloom].ts
import { createPagesApiHandler } from "@keyloom/nextjs";
import config from "@/keyloom.config";
export default createPagesApiHandler(config);
```

</Tab>
</Tabs>

### 3) Add middleware (recommended)

<Tabs>
<Tab value="basic" title="Basic">

```ts
// middleware.ts
import { createAuthMiddleware } from "@keyloom/nextjs/middleware";
import config from "@/keyloom.config";
export default createAuthMiddleware(config);
```

</Tab>
<Tab value="custom" title="Custom">

```ts
// middleware.ts
import { createAuthMiddleware } from "@keyloom/nextjs/middleware";
import config from "@/keyloom.config";
export default createAuthMiddleware(config, {
  // routes, customValidate, etc.
});
```

</Tab>
</Tabs>

### 4) Route protection patterns

<Tabs>
<Tab value="app-guard" title="App Router: guard()">

```ts
// app/(private)/dashboard/page.tsx
import { guard } from "@keyloom/nextjs";
export default async function Dashboard() {
  const { user } = await guard({
    visibility: "private",
    redirectTo: "/sign-in",
  });
  return <div>Hello {user?.name}</div>;
}
```

</Tab>
<Tab value="pages-ssr" title="Pages Router: SSR">

```ts
// pages/dashboard.tsx
import { getSession } from "@keyloom/nextjs";
export async function getServerSideProps() {
  const { user } = await getSession();
  if (!user) return { redirect: { destination: "/sign-in", permanent: false } };
  return { props: {} };
}
export default function Page() {
  return <div>Dashboard</div>;
}
```

</Tab>
</Tabs>

### 5) Server Components vs Client Components

- Server Components: Fetch sessions with `getSession()` or use `guard()` in server code.
- Client Components: UI forms (e.g., `SignInForm`, `SignUpForm`) run on the client; add `"use client"` at the top of your component file.

<Tabs>
<Tab value="client" title="Client form">

```tsx
"use client";
import { SignInForm } from "@keyloom/ui/auth";
export default function Page() {
  return <SignInForm />;
}
```

</Tab>
<Tab value="server" title="Server session">

```tsx
import { getSession } from "@keyloom/nextjs";
export default async function Page() {
  const { user } = await getSession();
  return <pre>{JSON.stringify(user, null, 2)}</pre>;
}
```

</Tab>
</Tabs>

### 6) API routes and CSRF

All Keyloom POST endpoints enforce CSRF. If you build custom forms, call `GET /api/auth/csrf` first and include the token in a hidden field named `csrf`.

</Steps>

## Best practices

- Prefer middleware + routes manifest for consistent protection
- Use database session strategy by default; choose JWT when appropriate
- Keep `NEXT_PUBLIC_APP_URL` stable and correct in all environments
- Ensure cookie domain/secure flags match your deployment

## Troubleshooting

- CSRF 403 on POST: ensure the shared API handler is mounted and requests include the CSRF token
- 401 after redirect: verify cookie domain/secure flags and that base URL matches the current origin
- OAuth callback errors: confirm exact redirect URIs in provider consoles
