---
title: Drizzle Adapter
description: Use Drizzle ORM to persist Keyloom users, sessions, OAuth accounts, and RBAC with PostgreSQL, MySQL, or SQLite.
---

import { Callout } from "fumadocs-ui/components/callout";
import { Steps, Step } from "fumadocs-ui/components/steps";
import { Tabs, Tab } from "fumadocs-ui/components/tabs";

# Drizzle Adapter

The Drizzle adapter provides database persistence for Keyloom using [Drizzle ORM](https://orm.drizzle.team/). It supports PostgreSQL, MySQL, and SQLite databases with full type safety and excellent performance.

## Features

- **Multi-Database Support**: PostgreSQL, MySQL, and SQLite
- **Full Type Safety**: Complete TypeScript integration with Drizzle
- **RBAC Support**: Organizations, roles, and permissions
- **Refresh Tokens**: Secure token rotation and family management
- **Audit Logging**: Track authentication events
- **Migrations**: Schema management with Drizzle Kit

## Installation

<Steps>
<Step>

### Install Dependencies

<Tabs items={["PostgreSQL", "MySQL", "SQLite"]}>
<Tab value="PostgreSQL">

```bash
npm install @keyloom/adapter-drizzle drizzle-orm postgres
npm install -D drizzle-kit
```

</Tab>
<Tab value="MySQL">

```bash
npm install @keyloom/adapter-drizzle drizzle-orm mysql2
npm install -D drizzle-kit
```

</Tab>
<Tab value="SQLite">

```bash
npm install @keyloom/adapter-drizzle drizzle-orm better-sqlite3
npm install -D drizzle-kit @types/better-sqlite3
```

</Tab>
</Tabs>

</Step>

<Step>

### Configure Database Connection

<Tabs items={["PostgreSQL", "MySQL", "SQLite"]}>
<Tab value="PostgreSQL">

```typescript title="lib/db.ts"
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";
import * as schema from "@keyloom/adapter-drizzle/schema";

const client = postgres(process.env.DATABASE_URL!);
export const db = drizzle(client, { schema });
```

</Tab>
<Tab value="MySQL">

```typescript title="lib/db.ts"
import { drizzle } from "drizzle-orm/mysql2";
import mysql from "mysql2/promise";
import * as schema from "@keyloom/adapter-drizzle/schema";

const connection = await mysql.createConnection(process.env.DATABASE_URL!);
export const db = drizzle(connection, { schema });
```

</Tab>
<Tab value="SQLite">

```typescript title="lib/db.ts"
import { drizzle } from "drizzle-orm/better-sqlite3";
import Database from "better-sqlite3";
import * as schema from "@keyloom/adapter-drizzle/schema";

const sqlite = new Database("keyloom.db");
export const db = drizzle(sqlite, { schema });
```

</Tab>
</Tabs>

</Step>

<Step>

### Configure Keyloom

```typescript title="keyloom.config.ts"
import { defineKeyloom } from "@keyloom/core";
import { drizzleAdapter } from "@keyloom/adapter-drizzle";
import { db } from "./lib/db";

export default defineKeyloom({
  baseUrl: process.env.NEXT_PUBLIC_APP_URL!,
  adapter: drizzleAdapter({
    db,
    dialect: "postgresql", // or "mysql" or "sqlite"
  }),
  session: {
    strategy: "database",
    ttlMinutes: 60,
    rolling: true,
  },
  // ... other config
});
```

</Step>
</Steps>

## Configuration Options

```typescript
interface DrizzleAdapterConfig {
  /** Database dialect */
  dialect: "postgresql" | "mysql" | "sqlite";
  /** Enable debug logging for queries */
  enableQueryLogging?: boolean;
  /** Custom table prefix */
  tablePrefix?: string;
}
```

## Database Schema

The adapter uses a comprehensive schema that supports all Keyloom features:

### Core Tables

- **User**: User accounts and profile information
- **Account**: OAuth provider accounts linked to users
- **Session**: Active user sessions
- **VerificationToken**: Email verification and password reset tokens
- **AuditEvent**: Authentication event logging

### RBAC Tables (Optional)

- **Organization**: Multi-tenant organizations
- **Membership**: User-organization relationships with roles
- **Invite**: Organization invitations
- **Entitlements**: Organization feature flags

### Refresh Token Tables (Optional)

- **RefreshToken**: Secure token storage with family tracking

<Callout>
  The complete schema is available in the package at
  `@keyloom/adapter-drizzle/schema` and can be customized for your needs.
</Callout>

## Migrations

<Steps>
<Step>

### Configure Drizzle Kit

```typescript title="drizzle.config.ts"
import type { Config } from "drizzle-kit";

export default {
  schema: "./node_modules/@keyloom/adapter-drizzle/dist/schema.js",
  out: "./drizzle/migrations",
  dialect: "postgresql", // or "mysql" or "sqlite"
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

</Step>

<Step>

### Generate and Run Migrations

```bash
# Generate migration files
npx drizzle-kit generate

# Apply migrations
npx drizzle-kit migrate
```

</Step>
</Steps>

## Advanced Usage

### Custom Schema Extensions

You can extend the base schema with your own tables:

```typescript title="lib/schema.ts"
import * as keyloomSchema from "@keyloom/adapter-drizzle/schema";
import { pgTable, text, timestamp } from "drizzle-orm/pg-core";

// Extend with custom tables
export const customTable = pgTable("custom_table", {
  id: text("id").primaryKey(),
  data: text("data"),
  createdAt: timestamp("created_at").defaultNow(),
});

// Combine schemas
export const schema = {
  ...keyloomSchema,
  customTable,
};
```

### Connection Pooling

For production applications, use connection pooling:

```typescript title="lib/db.ts"
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";

const client = postgres(process.env.DATABASE_URL!, {
  max: 10, // Maximum connections
  idle_timeout: 20,
  connect_timeout: 10,
});

export const db = drizzle(client);
```

## Troubleshooting

### Common Issues

**Migration Errors**

- Ensure your database user has CREATE/ALTER permissions
- Check that the database exists before running migrations
- Verify the connection string format for your database

**Type Errors**

- Make sure all peer dependencies are installed
- Check that your TypeScript version is compatible (>=5.0)
- Ensure schema imports match your database dialect

**Performance Issues**

- Add appropriate indexes for your query patterns
- Use connection pooling in production
- Consider read replicas for high-traffic applications

<Callout>
  For more advanced configuration and troubleshooting, see the [Drizzle ORM
  documentation](https://orm.drizzle.team/).
</Callout>
