---
title: MongoDB Adapter
description: Use MongoDB to persist Keyloom users, sessions, OAuth accounts, and authentication data.
---

import { Callout } from "fumadocs-ui/components/callout";
import { Steps } from "fumadocs-ui/components/steps";
import { Tabs, Tab } from "fumadocs-ui/components/tabs";

# MongoDB Adapter

The MongoDB adapter provides NoSQL database persistence for Keyloom using the native MongoDB driver. It offers flexible document storage with automatic indexing and efficient querying.

## Features

- **Document Storage**: Flexible schema with MongoDB's document model
- **Automatic Indexing**: Optimized queries for authentication operations
- **Connection Pooling**: Built-in connection management
- **Flexible Collections**: Customizable collection names and prefixes
- **Audit Logging**: Track authentication events in MongoDB

<Callout type="info">
The MongoDB adapter currently provides core authentication features. RBAC and refresh token features are planned for future releases.
</Callout>

## Installation

<Steps>
<Step>

### Install Dependencies

```bash
npm install @keyloom/adapters-mongo mongodb
```

</Step>

<Step>

### Configure Database Connection

```typescript title="lib/db.ts"
import { MongoClient } from "mongodb";

const client = new MongoClient(process.env.DATABASE_URL!, {
  maxPoolSize: 10,
  serverSelectionTimeoutMS: 5000,
  socketTimeoutMS: 45000,
});

// Connect to MongoDB
await client.connect();

export const db = client.db("keyloom");
```

</Step>

<Step>

### Configure Keyloom

```typescript title="keyloom.config.ts"
import { defineKeyloom } from "@keyloom/core";
import { mongoAdapter } from "@keyloom/adapters-mongo";
import { db } from "./lib/db";

export default defineKeyloom({
  baseUrl: process.env.NEXT_PUBLIC_APP_URL!,
  adapter: mongoAdapter(db, {
    collectionPrefix: "keyloom_",
    authSecret: process.env.AUTH_SECRET!,
  }),
  session: {
    strategy: "database",
    ttlMinutes: 60,
    rolling: true,
  },
  // ... other config
});
```

</Step>
</Steps>

## Configuration Options

```typescript
interface MongoAdapterConfig {
  /** Prefix for collection names */
  collectionPrefix?: string;
  /** Secret for token hashing */
  authSecret?: string;
}
```

## Collections Schema

The adapter creates the following collections:

### Core Collections

**Users Collection**
```javascript
{
  _id: ObjectId,
  id: "uuid-string",
  email: "user@example.com",
  emailVerified: Date | null,
  name: "User Name",
  image: "https://avatar.url",
  createdAt: Date,
  updatedAt: Date
}
```

**Accounts Collection**
```javascript
{
  _id: ObjectId,
  id: "uuid-string",
  userId: "user-uuid",
  type: "oauth",
  provider: "github",
  providerAccountId: "github-user-id",
  refresh_token: "token",
  access_token: "token",
  expires_at: Number,
  token_type: "bearer",
  scope: "read:user",
  id_token: "jwt-token"
}
```

**Sessions Collection**
```javascript
{
  _id: ObjectId,
  id: "session-uuid",
  sessionToken: "session-token",
  userId: "user-uuid",
  expires: Date,
  createdAt: Date,
  updatedAt: Date
}
```

**VerificationTokens Collection**
```javascript
{
  _id: ObjectId,
  identifier: "user@example.com",
  tokenHash: "hashed-token",
  expiresAt: Date,
  createdAt: Date
}
```

**AuditEvents Collection**
```javascript
{
  _id: ObjectId,
  id: "event-uuid",
  type: "sign_in",
  userId: "user-uuid",
  ip: "192.168.1.1",
  userAgent: "Mozilla/5.0...",
  timestamp: Date,
  metadata: {}
}
```

## Database Setup

### Indexes

The adapter automatically creates necessary indexes, but you can optimize further:

```javascript
// Users collection
db.keyloom_User.createIndex({ email: 1 }, { unique: true, sparse: true });
db.keyloom_User.createIndex({ id: 1 }, { unique: true });

// Accounts collection
db.keyloom_Account.createIndex({ userId: 1 });
db.keyloom_Account.createIndex({ provider: 1, providerAccountId: 1 }, { unique: true });

// Sessions collection
db.keyloom_Session.createIndex({ sessionToken: 1 }, { unique: true });
db.keyloom_Session.createIndex({ userId: 1 });
db.keyloom_Session.createIndex({ expires: 1 }, { expireAfterSeconds: 0 });

// Verification tokens
db.keyloom_VerificationToken.createIndex({ identifier: 1, tokenHash: 1 }, { unique: true });
db.keyloom_VerificationToken.createIndex({ expiresAt: 1 }, { expireAfterSeconds: 0 });
```

### Connection Management

For production applications, configure connection pooling:

```typescript title="lib/db.ts"
import { MongoClient } from "mongodb";

const client = new MongoClient(process.env.DATABASE_URL!, {
  // Connection pool settings
  maxPoolSize: 10,
  minPoolSize: 2,
  maxIdleTimeMS: 30000,
  
  // Timeout settings
  serverSelectionTimeoutMS: 5000,
  socketTimeoutMS: 45000,
  connectTimeoutMS: 10000,
  
  // Retry settings
  retryWrites: true,
  retryReads: true,
});

// Handle connection events
client.on('connectionPoolCreated', () => {
  console.log('MongoDB connection pool created');
});

client.on('connectionPoolClosed', () => {
  console.log('MongoDB connection pool closed');
});

export const db = client.db("keyloom");
```

## Advanced Usage

### Custom Collection Names

```typescript
const adapter = mongoAdapter(db, {
  collectionPrefix: "auth_",
  authSecret: process.env.AUTH_SECRET!,
});

// This creates collections: auth_User, auth_Account, etc.
```

### Multiple Database Support

```typescript
// Separate databases for different environments
const authDb = client.db(`keyloom_${process.env.NODE_ENV}`);
const adapter = mongoAdapter(authDb);
```

### Aggregation Queries

You can extend the adapter with custom aggregation queries:

```typescript
// Custom user analytics
const userStats = await db.collection("keyloom_User").aggregate([
  {
    $group: {
      _id: { $dateToString: { format: "%Y-%m", date: "$createdAt" } },
      count: { $sum: 1 }
    }
  },
  { $sort: { _id: 1 } }
]).toArray();
```

## Troubleshooting

### Common Issues

**Connection Errors**
- Verify your MongoDB connection string format
- Check network connectivity and firewall settings
- Ensure MongoDB server is running and accessible

**Index Errors**
- Drop and recreate indexes if schema changes
- Check for duplicate data that violates unique constraints
- Monitor index usage with MongoDB Compass

**Performance Issues**
- Add appropriate indexes for your query patterns
- Use MongoDB profiler to identify slow queries
- Consider sharding for very large datasets

**Memory Issues**
- Adjust connection pool settings
- Monitor memory usage in MongoDB Atlas
- Use projection to limit returned fields

<Callout>
For MongoDB Atlas users, enable connection pooling and use read preferences for better performance.
</Callout>

## Migration from Other Adapters

When migrating from other database adapters:

1. Export your existing user data
2. Transform the data to match MongoDB document structure
3. Import using MongoDB's bulk operations
4. Update your Keyloom configuration
5. Test authentication flows thoroughly

<Callout type="warning">
Always backup your data before migrating between different database systems.
</Callout>
