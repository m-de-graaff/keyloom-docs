---
title: Migrate from Firebase Auth
description: Complete guide to migrate from Firebase Authentication to Keyloom with user data preservation.
---

import { Steps, Step } from "fumadocs-ui/components/steps";
import { Callout } from "fumadocs-ui/components/callout";
import { Tabs, Tab } from "fumadocs-ui/components/tabs";

# Migrate from Firebase Auth

This guide walks you through migrating from Firebase Authentication to Keyloom while preserving your user data and maintaining authentication functionality.

<Callout type="info">
  Firebase Auth migration is typically straightforward since both systems
  support similar OAuth providers and user data structures.
</Callout>

## Pre-Migration Checklist

Before starting the migration:

- [ ] **Export Firebase users**: Download user data from Firebase Console
- [ ] **Inventory authentication methods**: List all sign-in providers used
- [ ] **Document custom claims**: Note any custom user claims or metadata
- [ ] **Plan database migration**: Choose your target database for Keyloom
- [ ] **Test environment**: Set up staging environment for testing

## Migration Overview

The migration process involves:

1. **Setup Keyloom** with equivalent providers
2. **Export user data** from Firebase
3. **Transform and import** users into Keyloom database
4. **Update application code** to use Keyloom
5. **Handle password migration** for email/password users
6. **Test and deploy** the new authentication system

<Steps>
<Step>

### Install and Configure Keyloom

Install Keyloom with similar providers to your Firebase setup:

```bash
npm install @keyloom/core @keyloom/nextjs @keyloom/providers @keyloom/adapters
```

Initialize Keyloom:

```bash
npx keyloom init --session database --adapter prisma --providers google,github,apple --rbac
```

Configure providers in `keyloom.config.ts`:

```typescript title="keyloom.config.ts"
import { defineKeyloom } from "@keyloom/core";
import { prismaAdapter } from "@keyloom/adapters";
import google from "@keyloom/providers/google";
import github from "@keyloom/providers/github";
import apple from "@keyloom/providers/apple";
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

export default defineKeyloom({
  adapter: prismaAdapter(prisma),
  baseUrl: process.env.NEXT_PUBLIC_APP_URL!,
  session: { strategy: "database" },
  providers: [
    google({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    github({
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    }),
    apple({
      clientId: process.env.APPLE_CLIENT_ID!,
      teamId: process.env.APPLE_TEAM_ID!,
      keyId: process.env.APPLE_KEY_ID!,
      privateKey: process.env.APPLE_PRIVATE_KEY!,
    }),
  ],
});
```

</Step>

<Step>

### Export Users from Firebase

<Tabs>
<Tab value="console" label="Firebase Console">

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project
3. Navigate to "Authentication" â†’ "Users"
4. Click "Export users" button
5. Download the JSON file

</Tab>

<Tab value="admin-sdk" label="Firebase Admin SDK">

```javascript title="scripts/export-firebase-users.js"
const admin = require("firebase-admin");
const fs = require("fs");

// Initialize Firebase Admin SDK
const serviceAccount = require("./path/to/serviceAccountKey.json");
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

async function exportUsers() {
  const users = [];
  let nextPageToken;

  do {
    const listUsersResult = await admin.auth().listUsers(1000, nextPageToken);

    listUsersResult.users.forEach((userRecord) => {
      users.push(transformFirebaseUser(userRecord));
    });

    nextPageToken = listUsersResult.pageToken;
  } while (nextPageToken);

  console.log(`Exported ${users.length} users`);

  fs.writeFileSync(
    "firebase-users-export.json",
    JSON.stringify(users, null, 2)
  );
}

function transformFirebaseUser(firebaseUser) {
  return {
    id: firebaseUser.uid,
    email: firebaseUser.email,
    emailVerified: firebaseUser.emailVerified ? new Date() : null,
    name: firebaseUser.displayName,
    image: firebaseUser.photoURL,
    createdAt: new Date(firebaseUser.metadata.creationTime),
    updatedAt: new Date(firebaseUser.metadata.lastSignInTime),
    disabled: firebaseUser.disabled,
    // Map Firebase providers to Keyloom accounts
    accounts: firebaseUser.providerData.map((provider) => ({
      provider: mapFirebaseProvider(provider.providerId),
      providerAccountId: provider.uid,
      type: "oauth",
    })),
    // Handle password users
    hasPassword: firebaseUser.providerData.some(
      (p) => p.providerId === "password"
    ),
    // Custom claims
    customClaims: firebaseUser.customClaims || {},
  };
}

function mapFirebaseProvider(firebaseProvider) {
  const providerMap = {
    "google.com": "google",
    "github.com": "github",
    "apple.com": "apple",
    "microsoft.com": "microsoft",
    "twitter.com": "x",
    "facebook.com": "facebook",
    password: "credentials",
  };
  return providerMap[firebaseProvider] || firebaseProvider;
}

exportUsers().catch(console.error);
```

</Tab>

<Tab value="cli" label="Firebase CLI">

```bash
# Install Firebase CLI
npm install -g firebase-tools

# Login to Firebase
firebase login

# Export users (requires Blaze plan)
firebase auth:export users.json --project your-project-id
```

</Tab>
</Tabs>

</Step>

<Step>

### Import Users into Keyloom

Create a script to import the transformed user data:

```javascript title="scripts/import-firebase-users.js"
const { PrismaClient } = require("@prisma/client");
const bcrypt = require("bcryptjs");
const fs = require("fs");

const prisma = new PrismaClient();

async function importUsers() {
  const users = JSON.parse(
    fs.readFileSync("firebase-users-export.json", "utf8")
  );

  console.log(`Importing ${users.length} users...`);

  for (const user of users) {
    try {
      // Skip disabled users or handle them separately
      if (user.disabled) {
        console.log(`Skipping disabled user: ${user.email}`);
        continue;
      }

      // Create user
      const createdUser = await prisma.user.create({
        data: {
          id: user.id,
          email: user.email,
          emailVerified: user.emailVerified,
          name: user.name,
          image: user.image,
          createdAt: user.createdAt,
          updatedAt: user.updatedAt,
        },
      });

      // Create OAuth accounts
      for (const account of user.accounts) {
        if (account.provider !== "credentials") {
          await prisma.account.create({
            data: {
              userId: createdUser.id,
              type: account.type,
              provider: account.provider,
              providerAccountId: account.providerAccountId,
            },
          });
        }
      }

      // Handle password users
      if (user.hasPassword) {
        // Firebase password hashes cannot be imported
        // Users will need to reset passwords
        await prisma.credential.create({
          data: {
            userId: createdUser.id,
            hashedPassword: await bcrypt.hash(
              "TEMP_PASSWORD_RESET_REQUIRED",
              12
            ),
            requiresReset: true,
          },
        });
      }

      // Import custom claims as user metadata
      if (user.customClaims && Object.keys(user.customClaims).length > 0) {
        await prisma.userMetadata.create({
          data: {
            userId: createdUser.id,
            data: user.customClaims,
          },
        });
      }

      console.log(`Imported user: ${user.email}`);
    } catch (error) {
      console.error(`Failed to import user ${user.email}:`, error.message);
    }
  }

  console.log("User import completed");
}

importUsers()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

</Step>

<Step>

### Handle Password Migration

Firebase password hashes cannot be directly imported. Choose a migration strategy:

<Tabs>
<Tab value="reset" label="Password Reset (Recommended)">

```javascript title="scripts/send-password-reset-emails.js"
const { PrismaClient } = require("@prisma/client");
const nodemailer = require("nodemailer");

const prisma = new PrismaClient();

async function sendPasswordResetEmails() {
  const users = await prisma.user.findMany({
    where: {
      credentials: {
        requiresReset: true,
      },
    },
  });

  const transporter = nodemailer.createTransporter({
    // Your email configuration
  });

  for (const user of users) {
    if (user.email) {
      await transporter.sendMail({
        from: "noreply@yourapp.com",
        to: user.email,
        subject: "Password Reset Required - Migration to New System",
        html: `
          <h2>Password Reset Required</h2>
          <p>We've migrated to a new authentication system.</p>
          <p>Please reset your password to continue accessing your account:</p>
          <a href="${
            process.env.APP_URL
          }/reset-password?token=${generateResetToken(user.id)}">
            Reset Password
          </a>
        `,
      });

      console.log(`Sent password reset to: ${user.email}`);
    }
  }
}

sendPasswordResetEmails().catch(console.error);
```

</Tab>

<Tab value="gradual" label="Gradual Migration">

```javascript title="middleware/firebase-fallback.js"
const admin = require("firebase-admin");

// Initialize Firebase Admin SDK for fallback
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

export async function authenticateWithFallback(email, password) {
  // Try Keyloom first
  try {
    const user = await authenticateWithKeyloom(email, password);
    if (user) return user;
  } catch (error) {
    console.log("Keyloom auth failed, trying Firebase fallback");
  }

  // Fallback to Firebase
  try {
    // Use Firebase Admin SDK to verify the user
    const firebaseUser = await admin.auth().getUserByEmail(email);

    // Verify password using Firebase Auth REST API
    const isValidPassword = await verifyFirebasePassword(email, password);

    if (isValidPassword) {
      // Migrate user on successful Firebase login
      await migrateUserFromFirebase(firebaseUser, password);
      return await authenticateWithKeyloom(email, password);
    }
  } catch (error) {
    console.error("Firebase fallback failed:", error);
  }

  throw new Error("Authentication failed");
}
```

</Tab>
</Tabs>

</Step>

<Step>

### Update Application Code

Replace Firebase Auth SDK calls with Keyloom:

<Tabs>
<Tab value="web" label="Web SDK">

```typescript title="Before (Firebase)"
import { initializeApp } from "firebase/app";
import {
  getAuth,
  signInWithEmailAndPassword,
  signInWithPopup,
  GoogleAuthProvider,
  onAuthStateChanged,
} from "firebase/auth";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Sign in with email/password
const signIn = async (email, password) => {
  const result = await signInWithEmailAndPassword(auth, email, password);
  return result.user;
};

// Sign in with Google
const signInWithGoogle = async () => {
  const provider = new GoogleAuthProvider();
  const result = await signInWithPopup(auth, provider);
  return result.user;
};

// Listen to auth state
onAuthStateChanged(auth, (user) => {
  if (user) {
    console.log("User signed in:", user);
  } else {
    console.log("User signed out");
  }
});
```

```typescript title="After (Keyloom)"
import { signIn, signOut, getSession } from "@keyloom/nextjs/client";

// Sign in with email/password
const handleSignIn = async (email, password) => {
  const result = await signIn("credentials", { email, password });
  return result;
};

// Sign in with Google
const signInWithGoogle = async () => {
  const result = await signIn("google");
  return result;
};

// Get current session
const getCurrentUser = async () => {
  const session = await getSession();
  return session?.user;
};

// Sign out
const handleSignOut = async () => {
  await signOut();
};
```

</Tab>

<Tab value="react" label="React Components">

```typescript title="Before (Firebase)"
import { useAuthState } from "react-firebase-hooks/auth";
import { auth } from "./firebase-config";

function Profile() {
  const [user, loading, error] = useAuthState(auth);

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;

  return user ? (
    <div>
      <h1>Welcome, {user.displayName}</h1>
      <img src={user.photoURL} alt="Profile" />
      <button onClick={() => auth.signOut()}>Sign Out</button>
    </div>
  ) : (
    <div>Please sign in</div>
  );
}
```

```typescript title="After (Keyloom)"
import { useSession } from "@keyloom/nextjs/client";
import { signOut } from "@keyloom/nextjs/client";

function Profile() {
  const { data: session, status } = useSession();

  if (status === "loading") return <div>Loading...</div>;

  return session?.user ? (
    <div>
      <h1>Welcome, {session.user.name}</h1>
      <img src={session.user.image} alt="Profile" />
      <button onClick={() => signOut()}>Sign Out</button>
    </div>
  ) : (
    <div>Please sign in</div>
  );
}
```

</Tab>

<Tab value="server" label="Server-Side">

```typescript title="Before (Firebase Admin)"
import admin from "firebase-admin";

// Verify ID token
export async function verifyToken(idToken) {
  try {
    const decodedToken = await admin.auth().verifyIdToken(idToken);
    return decodedToken;
  } catch (error) {
    throw new Error("Invalid token");
  }
}

// Get user by ID
export async function getUser(uid) {
  const userRecord = await admin.auth().getUser(uid);
  return userRecord;
}
```

```typescript title="After (Keyloom)"
import { getSession, getUser } from "@keyloom/nextjs";
import config from "@/keyloom.config";

// Get current session
export async function getCurrentSession(req) {
  const session = await getSession(config, { req });
  return session;
}

// Get user by ID
export async function getUserById(userId) {
  const user = await getUser(config, userId);
  return user;
}
```

</Tab>
</Tabs>

</Step>

<Step>

### Migrate Custom Claims

Convert Firebase custom claims to Keyloom user metadata:

```typescript title="keyloom.config.ts"
export default defineKeyloom({
  // ... other config
  hooks: {
    async afterSignIn(user, account, profile, isNewUser) {
      // Migrate custom claims from Firebase
      if (user.metadata?.customClaims) {
        const claims = user.metadata.customClaims;

        // Convert to Keyloom RBAC if needed
        if (claims.role) {
          await assignUserRole(user.id, claims.role);
        }

        if (claims.permissions) {
          await assignUserPermissions(user.id, claims.permissions);
        }

        // Store other custom data
        await updateUserMetadata(user.id, {
          department: claims.department,
          level: claims.level,
          // ... other custom fields
        });
      }
    },
  },
});
```

</Step>

<Step>

### Test the Migration

Create comprehensive tests for your migration:

```typescript title="tests/firebase-migration.test.ts"
import { test, expect } from "@playwright/test";

test.describe("Firebase to Keyloom Migration", () => {
  test("OAuth users can sign in", async ({ page }) => {
    await page.goto("/login");

    // Test Google sign in
    await page.click('[data-testid="google-signin"]');
    // ... test OAuth flow

    await expect(page.locator('[data-testid="user-profile"]')).toBeVisible();
  });

  test("password reset flow works", async ({ page }) => {
    await page.goto("/reset-password");

    await page.fill('[name="email"]', "migrated-user@example.com");
    await page.click('[type="submit"]');

    await expect(page.locator(".success-message")).toContainText(
      "Password reset email sent"
    );
  });

  test("custom claims are preserved", async ({ page }) => {
    await signInAsUser(page, "admin@example.com");

    const userData = await page.evaluate(() => {
      return fetch("/api/user/profile").then((r) => r.json());
    });

    expect(userData.role).toBe("admin");
    expect(userData.permissions).toContain("manage_users");
  });
});
```

</Step>

<Step>

### Deploy and Monitor

Deploy your Keyloom integration:

1. **Deploy to staging** and test thoroughly
2. **Update DNS/CDN** to point to new authentication endpoints
3. **Monitor authentication metrics** for issues
4. **Set up alerts** for authentication failures
5. **Have rollback plan** ready if needed

```typescript title="monitoring/auth-metrics.ts"
// Monitor authentication success rates
export async function trackAuthMetrics() {
  const metrics = await prisma.auditLog.groupBy({
    by: ["type"],
    where: {
      timestamp: {
        gte: new Date(Date.now() - 24 * 60 * 60 * 1000), // Last 24 hours
      },
    },
    _count: true,
  });

  const signInAttempts =
    metrics.find((m) => m.type === "sign_in_attempt")?._count || 0;
  const signInSuccesses =
    metrics.find((m) => m.type === "sign_in_success")?._count || 0;

  const successRate =
    signInAttempts > 0 ? (signInSuccesses / signInAttempts) * 100 : 0;

  if (successRate < 95) {
    // Alert on low success rate
    await sendAlert(
      `Authentication success rate is ${successRate.toFixed(2)}%`
    );
  }
}
```

</Step>
</Steps>

## Common Migration Challenges

### Firebase Security Rules

**Problem**: Firebase Security Rules don't apply to Keyloom.

**Solution**: Implement equivalent authorization logic in your application:

```typescript
// Before (Firebase Security Rules)
// rules_version = '2';
// service cloud.firestore {
//   match /databases/{database}/documents {
//     match /users/{userId} {
//       allow read, write: if request.auth != null && request.auth.uid == userId;
//     }
//   }
// }

// After (Keyloom middleware)
export async function authorizationMiddleware(req, res, next) {
  const session = await getSession(config, { req });

  if (!session) {
    return res.status(401).json({ error: "Unauthorized" });
  }

  // Check if user can access the resource
  const resourceUserId = req.params.userId;
  if (session.user.id !== resourceUserId && !session.user.isAdmin) {
    return res.status(403).json({ error: "Forbidden" });
  }

  next();
}
```

### Real-time Authentication State

**Problem**: Firebase provides real-time auth state updates.

**Solution**: Implement similar functionality with Keyloom:

```typescript
// Custom hook for real-time auth state
export function useAuthState() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Check initial auth state
    getSession().then((session) => {
      setUser(session?.user || null);
      setLoading(false);
    });

    // Listen for auth state changes
    const handleStorageChange = (e) => {
      if (e.key === "keyloom.session") {
        // Session changed, refresh user state
        getSession().then((session) => {
          setUser(session?.user || null);
        });
      }
    };

    window.addEventListener("storage", handleStorageChange);
    return () => window.removeEventListener("storage", handleStorageChange);
  }, []);

  return { user, loading };
}
```

## Post-Migration Tasks

After successful migration:

- [ ] **Decommission Firebase Auth** after stable period
- [ ] **Update documentation** with new authentication flows
- [ ] **Monitor user feedback** and authentication issues
- [ ] **Optimize database queries** for authentication performance
- [ ] **Set up backup and recovery** procedures for user data

## Cost Savings

Estimate your savings after migrating from Firebase Auth:

```
Firebase Auth Pricing (per verification):
- 0-50K verifications/month: Free
- 50K+ verifications/month: $0.0055 per verification

Example for 100K monthly verifications:
- Firebase: $275/month = $3,300/year
- Keyloom: $0/year (hosting costs only)
- Annual Savings: $3,300
```

<Callout type="success">
  Most applications see 80-95% cost reduction when migrating from Firebase Auth
  to Keyloom.
</Callout>
