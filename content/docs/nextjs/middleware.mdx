---
title: Middleware
description: Protect routes and attach session context using Keyloom's Next.js middleware.
---

# Middleware

Use Keyloom's middleware to protect pages and APIs, attach session context, and optionally run verification at the edge.

```ts title="middleware.ts"
import { createAuthMiddleware } from "@keyloom/nextjs/middleware";
import config from "@/keyloom.config";

export default createAuthMiddleware(config, {
  publicRoutes: ["/", "/sign-in", "/api/health"],
  verifyAtEdge: false,
  // routes: compiledManifest, // optional - for declarative gating
});

export const config = {
  matcher: ["/((?!_next|.*\\.(?:ico|png|jpg|svg|css|js|map)).*)"],
};
```

## Options

- `publicRoutes: string[]` - paths that do not require auth
- `verifyAtEdge: boolean` - when true, verify JWT/session at the edge
- `routes` - optional manifest to declare which routes require which roles

## Behavior

- Reads the incoming cookie token
- Optionally verifies at edge and attaches lightweight auth hints
- Redirects to your sign-in page if a protected page is accessed without a valid session
- Works in both app and pages router

## Patterns

- Use `publicRoutes` to allow public marketing pages
- Prefer server-side gating for sensitive APIs as an additional layer
- Consider `verifyAtEdge: true` when you need early blocking and are using an edge-safe strategy (JWT + edge-safe adapter)

## Troubleshooting

- Ensure your `matcher` excludes Next.js internals and static assets
- If redirects loop, verify `baseUrl` and cookie domain/path settings
- In development, set `cookie.secure: false`

