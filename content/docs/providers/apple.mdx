---
title: Apple Provider
description: Configure Sign in with Apple OAuth with Keyloom for iOS, macOS, and web authentication.
---

import { Callout } from "fumadocs-ui/components/callout";
import { Steps, Step } from "fumadocs-ui/components/steps";

# Apple Provider

The Apple provider enables "Sign in with Apple" authentication. Required for iOS apps that use third-party authentication and recommended for apps targeting Apple users across all platforms.

## Features

- **Sign in with Apple**: Official Apple authentication
- **Privacy Focused**: Apple's privacy-first approach
- **Cross-Platform**: Works on iOS, macOS, and web
- **Email Relay**: Optional private email relay service
- **JWT-Based**: Uses JWT for client secret generation

## Setup

<Steps>
<Step>

### Create Apple Developer Account

1. Enroll in the [Apple Developer Program](https://developer.apple.com/programs/)
2. Access the [Apple Developer Portal](https://developer.apple.com/account/)

</Step>

<Step>

### Create App ID

1. Go to "Certificates, Identifiers & Profiles"
2. Click "Identifiers" → "App IDs"
3. Create a new App ID or select existing one
4. Enable "Sign In with Apple" capability

</Step>

<Step>

### Create Services ID

1. Go to "Identifiers" → "Services IDs"
2. Click the "+" button to create new Services ID
3. Configure:
   - **Description**: Your app name
   - **Identifier**: Reverse domain (e.g., `com.yourcompany.yourapp.web`)
4. Enable "Sign In with Apple"
5. Configure domains and return URLs:
   - **Domains**: `yourdomain.com`
   - **Return URLs**: `https://yourdomain.com/api/auth/callback/apple`

</Step>

<Step>

### Create Private Key

1. Go to "Keys"
2. Click the "+" button to create new key
3. Configure:
   - **Key Name**: Sign in with Apple Key
   - **Enable**: Sign In with Apple
   - **Configure**: Select your primary App ID
4. Download the `.p8` key file (you can only download once!)
5. Note the **Key ID** (10-character string)

</Step>

<Step>

### Get Team ID

1. Go to "Membership" in the developer portal
2. Copy your **Team ID** (10-character string)

</Step>

<Step>

### Environment Variables

Add your Apple credentials:

```bash title=".env.local"
APPLE_CLIENT_ID=com.yourcompany.yourapp.web
APPLE_TEAM_ID=your_team_id
APPLE_KEY_ID=your_key_id
APPLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
your_private_key_content_here
-----END PRIVATE KEY-----"
```

</Step>

<Step>

### Configure Keyloom

```typescript title="keyloom.config.ts"
import { defineKeyloom } from "@keyloom/core";
import apple from "@keyloom/providers/apple";

export default defineKeyloom({
  // ... other config
  providers: [
    apple({
      clientId: process.env.APPLE_CLIENT_ID!,
      teamId: process.env.APPLE_TEAM_ID!,
      keyId: process.env.APPLE_KEY_ID!,
      privateKey: process.env.APPLE_PRIVATE_KEY!,
    }),
  ],
});
```

</Step>
</Steps>

## Configuration Options

```typescript
interface AppleProviderOptions {
  /** Services ID (e.g., 'com.example.app.web') */
  clientId: string;
  /** Apple Developer Team ID */
  teamId: string;
  /** Private key ID from Apple Developer Portal */
  keyId: string;
  /** Private key content from .p8 file */
  privateKey: string;
  /** Requested scope (default: 'name email') */
  scope?: "name email" | string;
}
```

## User Profile

The Apple provider returns user information from the ID token:

```typescript
interface AppleProfile {
  id: string; // Apple user ID (sub claim)
  email: string | null; // User's email (may be private relay)
  name: string | null; // User's name (only on first sign-in)
  image: string | null; // Always null (Apple doesn't provide avatars)
  emailVerified?: boolean; // Email verification status
}
```

<Callout type="info">
  Apple only provides the user's name on the **first sign-in**. Subsequent
  sign-ins will have `name: null`. Store the name in your database on first
  authentication.
</Callout>

## Apple-Specific Behavior

### Private Email Relay

Users can choose to hide their email address. Apple will provide a private relay email like `xyz123@privaterelay.appleid.com` that forwards to their real email.

### Name Availability

User names are only provided during the first authentication. Handle this in your application:

```typescript
// In your sign-in callback
async function handleAppleSignIn(profile: AppleProfile, account: Account) {
  const existingUser = await getUserByEmail(profile.email);

  if (!existingUser && profile.name) {
    // First sign-in - store the name
    await createUser({
      email: profile.email,
      name: profile.name,
      // ... other fields
    });
  }
}
```

### Response Mode

Apple uses `form_post` response mode, meaning the authorization response is sent as a POST request to your callback URL.

## Advanced Configuration

### Custom Scope

```typescript
apple({
  clientId: process.env.APPLE_CLIENT_ID!,
  teamId: process.env.APPLE_TEAM_ID!,
  keyId: process.env.APPLE_KEY_ID!,
  privateKey: process.env.APPLE_PRIVATE_KEY!,
  scope: "name email", // Default scope
});
```

### Private Key Handling

Store your private key securely:

```typescript
// Option 1: Environment variable (recommended for development)
const privateKey = process.env.APPLE_PRIVATE_KEY!;

// Option 2: File system (for production)
import fs from "fs";
const privateKey = fs.readFileSync("/path/to/AuthKey_KEYID.p8", "utf8");

// Option 3: Secret management service
const privateKey = await getSecretFromVault("apple-private-key");
```

### Client Secret Generation

The Apple provider automatically generates JWT client secrets. The process:

1. Creates JWT header with algorithm `ES256` and key ID
2. Creates JWT payload with issuer (team ID), subject (client ID), and audience
3. Signs with your private key using ES256 algorithm
4. Uses the JWT as the client secret for token exchange

## iOS Integration

For iOS apps using the same Apple credentials:

```swift
// iOS Swift code
import AuthenticationServices

@available(iOS 13.0, *)
class SignInWithAppleCoordinator: NSObject, ASAuthorizationControllerDelegate {
    func signInWithApple() {
        let request = ASAuthorizationAppleIDProvider().createRequest()
        request.requestedScopes = [.fullName, .email]

        let controller = ASAuthorizationController(authorizationRequests: [request])
        controller.delegate = self
        controller.presentationContextProvider = self
        controller.performRequests()
    }
}
```

## Troubleshooting

### Common Issues

**Invalid Client Error**

- Verify Services ID is correctly configured
- Check that "Sign In with Apple" is enabled for the Services ID
- Ensure the client ID matches your Services ID exactly

**Invalid Grant Error**

- Check that your private key is correctly formatted
- Verify the Key ID matches the key in Apple Developer Portal
- Ensure the Team ID is correct

**Redirect URI Mismatch**

- Verify return URLs in Services ID configuration
- Check for exact match including protocol and path
- Ensure domain is properly verified

**JWT Signature Verification Failed**

- Verify private key format (should include BEGIN/END markers)
- Check that the key corresponds to the Key ID
- Ensure the key hasn't been regenerated in Apple Developer Portal

### Testing

Test your Apple integration:

1. **Development**: Use localhost with proper SSL setup
2. **Staging**: Test with your staging domain
3. **Production**: Verify with production domain
4. **iOS**: Test native iOS integration if applicable

<Callout>
  Apple requires HTTPS for all callback URLs, including development. Use tools
  like ngrok for local HTTPS testing.
</Callout>

## Security Considerations

- **Private Key Security**: Store private keys securely, never in client-side code
- **Key Rotation**: Regularly rotate private keys (Apple allows multiple active keys)
- **JWT Expiration**: Client secrets expire after 6 months (automatically handled)
- **Scope Minimization**: Only request necessary scopes
- **Email Validation**: Handle private relay emails appropriately

## App Store Requirements

If your iOS app uses third-party authentication:

1. **Must offer Sign in with Apple** as an option
2. **Equal prominence** with other sign-in options
3. **Consistent user experience** across platforms
4. **Privacy compliance** with Apple's guidelines

## Migration from Other Providers

When adding Apple alongside existing providers:

1. **Account Linking**: Handle users who may have existing accounts with different emails
2. **Email Matching**: Consider private relay emails in your matching logic
3. **User Experience**: Provide clear options for account linking
4. **Data Migration**: Migrate existing user data appropriately

## Resources

- [Apple Developer Portal](https://developer.apple.com/account/)
- [Sign in with Apple Documentation](https://developer.apple.com/documentation/sign_in_with_apple)
- [Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/sign-in-with-apple)
- [App Store Review Guidelines](https://developer.apple.com/app-store/review/guidelines/)
- [Private Email Relay Service](https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api/authenticating_users_with_sign_in_with_apple)
