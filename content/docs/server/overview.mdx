---
title: Server (Fastify) Endpoints
description: The @keyloom/server package 6 prebuilt Fastify server with credential auth endpoints and JWKS routes for JWT.
---

# @keyloom/server

This package provides a Fastify server with production-ready endpoints for credential auth with either Database or JWT session strategies.

- Endpoints: `/v1/auth/*`, JWKS under `/.well-known/jwks.json`
- Dependencies: Prisma client (for the Prisma adapter), bcryptjs or @node-rs/argon2 for hashing

## Install

```bash
pnpm add @keyloom/server @keyloom/adapters @keyloom/core fastify
```

## Boot the server

```ts
import { Env } from "@keyloom/server/env"; // parsed from process.env
import { buildServer } from "@keyloom/server/routes/auth";

const env = Env.parse(process.env);
const app = buildServer(env);
app.listen({ port: Number(env.PORT), host: "0.0.0.0" });
```

## Endpoints

### CSRF
- `GET /v1/auth/csrf` → `{ csrfToken }` and sets `__keyloom_csrf`

### Register
- `POST /v1/auth/register` body: `{ email, password }`
- CSRF required: header `x-keyloom-csrf` must match cookie `__keyloom_csrf`
- Rate limit: token bucket (5 capacity, 0.2 refill/sec)
- Response: `{ userId, requiresVerification }`

### Login
- `POST /v1/auth/login` body: `{ email, password }`
- CSRF required; rate limit present
- Database strategy: sets `__keyloom_session` cookie and returns `{ sessionId }`
- JWT strategy: issues tokens and sets `__keyloom_access`, `__keyloom_refresh` cookies and returns `{ accessToken, userId }`

### Token Refresh (JWT only)
- `POST /v1/auth/token` body: `{ refreshToken? }` or via cookie `__keyloom_refresh`
- Returns new tokens; sets cookies

### Logout
- `POST /v1/auth/logout` clears session or JWT cookies; `{ ok: true }`

### Session
- `GET /v1/auth/session` → `{ session, user }` (JWT verifies access token; DB strategy checks session cookie)

### Organizations
- `POST /v1/orgs` → create org (auth required; creator becomes owner)
- `GET /v1/orgs` → list orgs for current user
- `POST /v1/orgs/:id/members` → add member via `userId` or issue invite via `email`
- `DELETE /v1/orgs/:id/members/:memberId` → remove member
- `POST /v1/invites/accept` → accept invitation with `{ orgId, token }`

### JWKS & Keystore (JWT)
- `GET /.well-known/jwks.json` → public keys (with cache headers and CORS)
- `GET /v1/auth/jwks` → same JWKS
- `GET /v1/auth/keystore/stats` → keystore info
- `POST /v1/auth/keystore/rotate` → force rotation (admin)

## Environment

Key variables (subset):
- `SESSION_STRATEGY=database|jwt`
- `JWT_ISSUER`, `JWT_AUDIENCE`, `JWT_CLOCK_SKEW_SEC`
- `JWKS_PATH` (optional persistence), `KEY_ROTATION_DAYS`, `KEY_OVERLAP_DAYS`
- `COOKIE_DOMAIN`, `COOKIE_SAMESITE`

## Error Handling & Rate Limiting

All endpoints consistently return JSON with `{ error: code }` on failure and appropriate HTTP status. Built-in token bucket limits sensitive endpoints; extend with your own limiter if needed.

## Integration Patterns

- Use this server standalone (e.g., as an auth service) together with `@keyloom/nextjs` frontend middleware
- Or, embed similar handlers in your existing Fastify app using the same adapter and JWT service utilities

