---
title: Migrate from other authentication solutions
---

import { Step, Steps } from "fumadocs-ui/components/steps";
import { Tabs, Tab } from "fumadocs-ui/components/tabs";
import { Callout } from "fumadocs-ui/components/callout";

This guide helps you migrate to Keyloom from NextAuth/Auth.js, custom JWT/cookie auth, or managed providers. It highlights key differences and provides working code examples.

## Overview

- Unified API handler: one Next.js route handles sessions, credentials, OAuth, CSRF
- Database or JWT sessions: database by default; opt into stateless JWT
- Explicit CSRF: double‑submit cookie with header verification
- Route protection: middleware + `guard()` server helper
- RBAC and orgs: pluggable via adapter helpers (optional)

## Step‑by‑step migration

<Steps>

### 1) Replace your auth API with Keyloom

<Tabs>
<Tab value="app-router" title="App Router">

```ts
// app/api/auth/[[...keyloom]]/route.ts
import { createNextHandler } from "@keyloom/nextjs";
import config from "@/keyloom.config";
export const { GET, POST } = createNextHandler(config);
```

</Tab>
<Tab value="pages-router" title="Pages Router">

```ts
// pages/api/auth/[...keyloom].ts
import { createPagesApiHandler } from "@keyloom/nextjs";
import config from "@/keyloom.config";
export default createPagesApiHandler(config);
```

</Tab>
</Tabs>

### 2) Configure adapter, baseUrl, and secrets

```ts
// keyloom.config.ts
import { PrismaAdapter } from "@keyloom/adapters";
import { PrismaClient } from "@prisma/client";
const db = new PrismaClient();
export default {
  baseUrl: process.env.NEXT_PUBLIC_APP_URL!,
  adapter: PrismaAdapter(db),
  // sessionStrategy: 'database' | 'jwt',
  secrets: { authSecret: process.env.AUTH_SECRET! },
};
```

<Callout>
  AUTH_SECRET must be base64url and decode to at least 32 bytes. Run `keyloom
  doctor --fix` to generate a valid secret.
</Callout>

### 3) Providers (OAuth)

```ts
import { github } from "@keyloom/providers";
export default {
  // ...
  providers: [
    github({
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    }),
  ],
};
```

### 4) Middleware and route protection

```ts
// middleware.ts
import { createAuthMiddleware } from "@keyloom/nextjs/middleware";
import config from "@/keyloom.config";
export default createAuthMiddleware(config);
```

```ts
// App Router server guard example
import { guard } from "@keyloom/nextjs";
export default async function Page() {
  await guard({ visibility: "private", redirectTo: "/sign-in" });
  // ...
}
```

### 5) Environment and validation

- NEXT_PUBLIC_APP_URL, AUTH_SECRET, DATABASE_URL (if using Prisma)
- Run `keyloom doctor` to verify env, cookies, and wiring

### 6) Sessions & cookies

- Database sessions: signed, HttpOnly cookie holds the session id
- JWT sessions: set `sessionStrategy: 'jwt'`; `baseUrl` is used to infer JWKS + issuer
- Endpoints remain the same for both strategies

### 7) CSRF

- All POST endpoints enforce double‑submit CSRF
- Fetch `GET /api/auth/csrf` and send the token back in the `x-keyloom-csrf` header

</Steps>

## From NextAuth/Auth.js

- Replace route handler with `createNextHandler`
- Switch adapter to `PrismaAdapter` from `@keyloom/adapters`
- If you previously used JWT, set `sessionStrategy: 'jwt'`
- Re‑create providers via `@keyloom/providers`

```ts
// Before (NextAuth)
// export const { GET, POST } = NextAuth(authOptions)

// After (Keyloom)
import { createNextHandler } from "@keyloom/nextjs";
import config from "@/keyloom.config";
export const { GET, POST } = createNextHandler(config);
```

## Verification checklist

- `keyloom doctor` passes (env, DB, cookies, middleware)
- `GET /api/auth/session` returns user/session when logged in
- OAuth redirects and callbacks complete successfully
- Password reset and email verification POSTs work with CSRF header
